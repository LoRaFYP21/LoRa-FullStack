# Network Architecture Diagrams

## System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LoRa Mesh Network System                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Node_1     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   Node_2     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   Node_3     â”‚
â”‚   (Endpoint) â”‚          â”‚   (Relay)    â”‚          â”‚   (Endpoint) â”‚
â”‚              â”‚          â”‚              â”‚          â”‚              â”‚
â”‚ - TX Data    â”‚          â”‚ - Forward    â”‚          â”‚ - RX Data    â”‚
â”‚ - Discovery  â”‚          â”‚ - Queue Mgmt â”‚          â”‚ - Send ACK   â”‚
â”‚ - Wait ACK   â”‚          â”‚ - Hop ACK    â”‚          â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                         â”‚                         â”‚
       â”‚                         â”‚                         â”‚
       â–¼                         â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       LoRa Physical Layer                         â”‚
â”‚  Frequency: 923 MHz  |  SF: 7-12  |  BW: 125 kHz  |  Power: 17dBmâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Protocol Stack

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Application Layer                                      â”‚
â”‚  - Text messaging                                       â”‚
â”‚  - File transfer (images, voice, MiniSEED)              â”‚
â”‚  - Command interface (SEND, ROUTES, STATS)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–² â”‚
                         â”‚ â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Reliability Layer                                      â”‚
â”‚  - ACK/NACK handling                                    â”‚
â”‚  - Fragmentation & Reassembly                           â”‚
â”‚  - Retry logic (0-5 attempts based on reliability)      â”‚
â”‚  - Timeout management                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–² â”‚
                         â”‚ â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Routing Layer (AODV-inspired)                          â”‚
â”‚  - Route discovery (RREQ/RREP)                          â”‚
â”‚  - Route maintenance (HELLO, RERR)                      â”‚
â”‚  - Routing table management                             â”‚
â”‚  - Duplicate detection                                  â”‚
â”‚  - TTL-based loop prevention                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–² â”‚
                         â”‚ â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MAC Layer                                              â”‚
â”‚  - Packet encoding/decoding                             â”‚
â”‚  - Relay queue management                               â”‚
â”‚  - Priority scheduling                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–² â”‚
                         â”‚ â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Physical Layer (LoRa)                                  â”‚
â”‚  - Modulation/Demodulation                              â”‚
â”‚  - RSSI/SNR measurement                                 â”‚
â”‚  - CRC checking                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Packet Structure

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         LoRa Packet                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Header (Variable)              â”‚  Payload (Variable)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ T<type>|S<src>|D<dst>|Q<seq>|  â”‚  Application data                â”‚
â”‚ H<hop>|L<ttl>|R<rel>|:         â”‚  (text, file chunk, control msg) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Header Fields:
  T (Type):         MSG type (0-8)
  S (Source):       Node name (e.g., "Node_1")
  D (Destination):  Node name or "BROADCAST"
  Q (Sequence):     Packet sequence number
  H (Hop Count):    Current hop count (incremented by relays)
  L (TTL):          Time-to-live (decremented by relays)
  R (Reliability):  Reliability level (0-4)
  : (Separator):    Header/Payload separator

Example Packet:
  "T0|SNode_1|DNode_3|Q123|H2|L8|R2|:Hello from Node 1!"

  Decoded:
    Type: 0 (DATA)
    Source: Node_1
    Dest: Node_3
    Seq: 123
    Hops: 2 (traveled through 2 relays)
    TTL: 8 (can go 8 more hops)
    Reliability: 2 (MEDIUM)
    Payload: "Hello from Node 1!"
```

## Route Discovery Flow

```
Scenario: Node_1 wants to send to Node_4 (no known route)

Step 1: RREQ Broadcast
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Node_1 â”‚â”€â”€â”€â”€â”€RREQâ”€â”€â”€â”€â”€â”€â”€â–ºâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚ Node_2 â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                           â”‚
     â”‚                           â”‚
     â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
     â””â”€â”€â”€â”€â”€RREQâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ Node_3 â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚ Node_4 â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 2: RREQ Propagation
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Node_1 â”‚                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚ Node_2 â”‚â”€â”€â”€RREQâ”€â”€â–ºâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚ Node_4 â”‚
                                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
                          â”‚ Node_3 â”‚â”€â”€â”€RREQâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 3: RREP from Destination
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Node_1 â”‚â—„â”€â”€â”€RREPâ”€â”€â”€â”€â”€â”€â”€â”€â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚ Node_2 â”‚â—„â”€â”€â”€RREPâ”€â”€â”€â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚ Node_4 â”‚
                                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
                          â”‚ Node_3 â”‚â—„â”€â”€â”€RREPâ”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 4: Route Established
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Node_1 â”‚ Route: via Node_2 (2 hops)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜        OR via Node_3 (2 hops)
                  (Uses first received RREP)

Routing Table at Node_1:
  Dest: Node_4, NextHop: Node_2, Hops: 2
```

## Data Flow with Multi-Hop ACK

```
Scenario: Node_1 sends critical data to Node_3 via Node_2

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Node_1 â”‚          â”‚ Node_2 â”‚          â”‚ Node_3 â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
    â”‚                   â”‚                   â”‚
    â”‚ DATA (hop=0)      â”‚                   â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                   â”‚
    â”‚                   â”‚                   â”‚
    â”‚â—„â”€â”€â”€â”€RACKâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
    â”‚ (hop-by-hop ACK)  â”‚                   â”‚
    â”‚                   â”‚                   â”‚
    â”‚                   â”‚ DATA (hop=1)      â”‚
    â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                   â”‚                   â”‚
    â”‚                   â”‚â—„â”€â”€â”€â”€RACKâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                   â”‚ (hop-by-hop ACK)  â”‚
    â”‚                   â”‚                   â”‚
    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€ACKâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚             (end-to-end ACK)          â”‚
    â”‚                                       â”‚

Timeline:
  t=0s    : Node_1 sends DATA
  t=0.1s  : Node_2 receives, sends RACK to Node_1
  t=0.2s  : Node_2 forwards DATA to Node_3
  t=0.3s  : Node_3 receives, sends RACK to Node_2
  t=0.4s  : Node_3 sends end-to-end ACK back to Node_1
  t=1.5s  : Node_1 receives ACK (success!)

If RACK not received:
  - Node_1 retries after timeout (15s for critical)
  - Max 5 retries for REL_CRITICAL
  - Reports failure if all retries exhausted
```

## Network Topology Examples

### Example A: Linear (Extended Range)

```
Node_1 â—„â”€1kmâ”€â–º Node_2 â—„â”€1kmâ”€â–º Node_3 â—„â”€1kmâ”€â–º Node_4

Total range: 3 km (with 2 relays)
Latency: ~6-12 seconds per packet
Throughput: ~0.3-0.7 kbps
Use case: Long-distance sensor network
```

### Example B: Star (Centralized)

```
              Node_2
                â–²
                â”‚
                â”‚
    Node_1 â—„â”€â”€â”€â”€Hubâ”€â”€â”€â”€â–º Node_3
                â”‚
                â”‚
                â–¼
              Node_4

Hub is gateway to internet/server
Latency: ~2-4 seconds per packet
Throughput: ~0.5-1 kbps per link
Use case: Data collection, monitoring
```

### Example C: Mesh (Redundant)

```
    Node_1 â—„â”€â”€â”€â”€â”€â”€â–º Node_2
      â–²  â•²         â•±  â–²
      â”‚    â•²     â•±    â”‚
      â”‚      â•² â•±      â”‚
      â”‚      â•± â•²      â”‚
      â”‚    â•±     â•²    â”‚
      â–¼  â•±         â•²  â–¼
    Node_3 â—„â”€â”€â”€â”€â”€â”€â–º Node_4

Multiple routes available
Automatic failover if node fails
Latency: ~2-4 seconds (varies by route)
Throughput: ~0.5-1 kbps
Use case: High reliability applications
```

### Example D: Hybrid (Mixed Topology)

```
         â”Œâ”€â”€â”€ Node_2 â”€â”€â”€â”€â”
         â”‚                â”‚
    Node_1               Node_5
         â”‚                â”‚
         â””â”€â”€â”€ Node_3 â”€â”€â”€â”€â”¼â”€â”€â”€ Node_6
                â”‚        â”‚
              Node_4   Node_7

Combines star and mesh
Flexible routing
Scalable to more nodes
Use case: Large deployments
```

## State Diagram: Node Operation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Node States                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   INIT   â”‚ (Power on, LoRa init)
              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”Œâ”€â”€â”€â”€â”¤   IDLE   â”‚â—„â”€â”€â”€â”€â”
         â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â”‚
         â”‚         â”‚            â”‚
         â”‚         â”‚ RX packet â”‚ Timeout
         â”‚         â–¼            â”‚
         â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
         â”‚    â”‚ RECEIVE  â”‚â”€â”€â”€â”€â”€â”˜
         â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚         â”‚
         â”‚         â”œâ”€â”€â–º RREQ â”€â”€â–º Forward/Reply
         â”‚         â”‚
         â”‚         â”œâ”€â”€â–º DATA â”€â”€â–º Process/Forward â”€â”€â–º Send ACK/RACK
         â”‚         â”‚
         â”‚         â””â”€â”€â–º ACK/RREP â”€â”€â–º Update Routes
         â”‚
         â”‚ Serial command
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ TRANSMIT â”‚ (Send DATA/RREQ/HELLO)
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â–º High reliability? â”€â”€Yesâ”€â”€â–º Wait for ACK â”€â”€â–º Success/Retry
         â”‚
         â””â”€â”€â–º Low/None â”€â”€â–º Return to IDLE

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  RELAY   â”‚ (Queue packet for forwarding)
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚
         â””â”€â”€â–º Process Queue â”€â”€â–º Forward â”€â”€â–º Return to IDLE

Background Tasks (always running):
- Send HELLO every 30s
- Clean routing table (every 60s)
- Clean seen messages (every 60s)
- Process relay queue
- Monitor serial input
```

## Memory Layout (ESP32)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ESP32 Memory (520 KB)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Program Code: ~100 KB                                          â”‚
â”‚  - Arduino core                                                 â”‚
â”‚  - LoRa library                                                 â”‚
â”‚  - Display drivers                                              â”‚
â”‚  - Mesh node firmware                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Dynamic Memory (Heap): ~200 KB                                 â”‚
â”‚  â”œâ”€â”€ Routing Table: ~10-20 KB (50-100 routes)                   â”‚
â”‚  â”œâ”€â”€ Seen Messages: ~5-10 KB (100-200 entries)                  â”‚
â”‚  â”œâ”€â”€ Relay Queue: ~5-10 KB (20 packets @ 250 bytes each)        â”‚
â”‚  â”œâ”€â”€ String Buffers: ~20-30 KB                                  â”‚
â”‚  â””â”€â”€ Free: ~150-160 KB                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Stack: ~8 KB                                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Reserved/OS: ~120 KB                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Memory usage scales with:
- Number of active routes (10-50 typical)
- Number of recent messages tracked (100-200 typical)
- Relay queue size (20 packets default)

Recommendation:
- For heavy relay nodes: Monitor heap with ESP.getFreeHeap()
- Keep relay queue â‰¤ 20 packets
- Route table auto-expires old entries
```

## Python Interface Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Python Application Layer                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  mesh_network_interface.py  â”‚  mesh_receiver.py                 â”‚
â”‚  - Send text/files           â”‚  - Receive messages              â”‚
â”‚  - Fragmentation             â”‚  - Reassembly                    â”‚
â”‚  - Progress tracking         â”‚  - File saving                   â”‚
â”‚  - Route management          â”‚  - Statistics                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â–² â”‚
                             â”‚ â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Serial Communication                       â”‚
â”‚  pyserial @ 115200 baud                                         â”‚
â”‚  - Command strings (SEND:dest:rel:data)                         â”‚
â”‚  - Response parsing ([TX], [RX], [ACK], etc.)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â–² â”‚
                             â”‚ â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Mesh Node (ESP32)                          â”‚
â”‚  MeshNode.ino                                                   â”‚
â”‚  - Command processing                                           â”‚
â”‚  - LoRa transmission/reception                                  â”‚
â”‚  - Routing, ACK handling                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Visual reference for understanding the mesh network architecture!** ğŸ“Š
